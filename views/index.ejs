<%- layout("layouts/boilerplate.ejs") %>

    <body>
        <div class="container mt-4">
            <!-- Total Counts Section -->
            <div class="text-center mb-4">
                <h2 class="display-4">Dashboard Overview</h2>
                <p class="text-muted">Quick summary of resources and recent activity</p>
            </div>

            <div class="row text-center">
                <!-- Card for Total Colleges -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/colleges" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-primary">Colleges</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalColleges %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalColleges"></span>
                                    <!-- Hidden loader inside the card -->
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total PYQs -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/pyqs" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-primary">PYQs</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalPYQs %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalPYQs"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Notes -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/notes" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-info">Notes</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalNotes %>
                                    </span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Groups -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/whatsappgroup" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-info">Groups</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalGroups %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalGroups"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Seniors -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/seniors" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-secondary">Seniors</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalSeniors %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalSeniors"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-secondary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Store Products -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/store" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-secondary">Store</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalProduct %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalProduct"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-secondary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Get Opportunity -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/opportunity/getopportunities" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title h6 text-warning">Get Opportunity</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalGetCommunity %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalGetCommunity"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-warning" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Give Opportunity -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/opportunity/giveopportunities" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title h6 text-warning">Give Opportunity</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalGiveCommunity %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalGiveCommunity"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-warning" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Communities -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/community" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title h6 text-success">Communities</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalPost %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalPost"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/contactus" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-success">Messages</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalMessages %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalMessages"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/pyqs/s/requested-pyqs" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-success">Req Pyqs</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalRequestedPyqs %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalRequestedPyqs"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Admins -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/user" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-danger">Admins</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalUsers %>
                                    </span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-danger" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Card for Total Users -->
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                    <a href="/client" class="text-decoration-none card-link">
                        <div class="card bg-light border-0 shadow-sm hover-card">
                            <div class="card-body">
                                <h5 class="card-title text-danger">Users</h5>
                                <h4 class="font-weight-bold text-dark">
                                    <span class="card-text">
                                        <%= totalClients %>
                                    </span>
                                    <span class="new-count d-none" data-key="totalClients"></span>
                                    <span class="card-loader d-none">
                                        <div class="spinner-border text-danger" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </span>
                                </h4>
                            </div>
                        </div>
                    </a>
                </div>

            </div>

            <!-- Recent Items Section -->
            <div class="mt-4">
                <div class="text-center mb-4">
                    <h2 class="display-5">Recent Items</h2>
                </div>

                <div class="row">
                    <!-- Recent PYQs -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                Recent PYQs
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentPYQs.forEach(pyq=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/pyqs/<%= pyq._id %>" class="text-decoration-none hover-item">
                                            <%= pyq.subjectName %> - <%= pyq.subjectCode %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label" for="pyqSwitch<%= pyq._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="pyqSwitch<%= pyq._id %>" <%=pyq.status ? 'checked' : '' %>
                                            onchange="toggleStatus('<%= pyq._id %>', this.checked, 'pyq')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>


                    <!-- Recent Colleges -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-warning text-white">
                                Recent Colleges
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentColleges.forEach(college=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/colleges/<%= college._id %>" class="text-decoration-none hover-item">
                                            <%= college.name %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="collegeSwitch<%= college._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="collegeSwitch<%= college._id %>" <%=college.status ? 'checked' : ''
                                                %>
                                            onchange="toggleStatus('<%= college._id %>', this.checked, 'college')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Products -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-danger text-white">
                                Recent Products
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentProducts.forEach(product=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/store" class="text-decoration-none hover-item">
                                            <%= product.name %> - â‚¹<%= product.price %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="productSwitch<%= product._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="productSwitch<%= product._id %>" <%=product.status ? 'checked' : ''
                                                %>
                                            onchange="toggleStatus('<%= product._id %>', this.checked, 'product')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Seniors -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-success text-white">
                                Recent Seniors
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentSeniors.forEach(senior=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/seniors/<%= senior._id %>" class="text-decoration-none hover-item">
                                            <%= senior.name %> - <%= senior.branch %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="seniorSwitch<%= senior._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="seniorSwitch<%= senior._id %>" <%=senior.status ? 'checked' : '' %>
                                            onchange="toggleStatus('<%= senior._id %>', this.checked, 'senior')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Notes -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-info text-white">
                                Recent Notes
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentNotes.forEach(note=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/notes" class="text-decoration-none hover-item">
                                            <%= note.subjectName %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="noteSwitch<%= note._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="noteSwitch<%= note._id %>" <%=note.status ? 'checked' : '' %>
                                            onchange="toggleStatus('<%= note._id %>', this.checked, 'note')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Groups -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                Recent Groups
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentGroups.forEach(group=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/whatsappgroup" class="text-decoration-none hover-item">
                                            <%= group.title %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="groupSwitch<%= group._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="groupSwitch<%= group._id %>" <%=group.status ? 'checked' : '' %>
                                            onchange="toggleStatus('<%= group._id %>', this.checked, 'group')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                Recent Get Opportunity
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentGetOpportunity.forEach(opportunity=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/opportunity/getopportunities/<%= opportunity._id %>"
                                            class="text-decoration-none hover-item">
                                            <%= opportunity.name %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="getOpportunitySwitch<%= opportunity._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="getOpportunitySwitch<%= opportunity._id %>" <%=opportunity.status
                                                ? 'checked' : '' %>
                                            onchange="toggleStatus('<%= opportunity._id %>', this.checked,
                                                'getOpportunity')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                Recent Give Opportunity
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentGiveOpportunity.forEach(opportunity=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/opportunity/giveopportunities/<%= opportunity._id %>"
                                            class="text-decoration-none hover-item">
                                            <%= opportunity.name %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <div class="form-check form-switch">
                                            <label class="form-check-label"
                                                for="giveOpportunitySwitch<%= opportunity._id %>">Status</label>
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                id="giveOpportunitySwitch<%= opportunity._id %>" <%=opportunity.status
                                                ? 'checked' : '' %>
                                            onchange="toggleStatus('<%= opportunity._id %>', this.checked,
                                                'giveOpportunity')">
                                        </div>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Posts-->
                    <div class="col-md-6 mb-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                Recent Posts
                            </div>
                            <ul class="list-group list-group-flush">
                                <% recentPosts.forEach(post=> { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="/community" class="text-decoration-none hover-item text-truncate">
                                            <%= post.content %>
                                        </a>
                                        <!-- Toggle Button -->
                                        <form action="/community/<%= post._id %>?_method=DELETE" method="POST">
                                            <button type="submit">
                                                <div>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                        fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                        <path
                                                            d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                                                        <path
                                                            d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                                                    </svg>
                                                </div>
                                            </button>
                                        </form>
                                    </li>
                                    <% }); %>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hover card effect -->
        <style>
            .hover-card:hover {
                transform: scale(1.05);
                transition: transform 0.3s ease-in-out;
            }

            .hover-item:hover {
                background-color: #f8f9fa;
                transition: background-color 0.2s ease-in-out;
            }

            .card-header {
                font-weight: bold;
            }

            li:hover {
                background-color: rgb(255, 255, 234);
            }

            .new-count {
                font-size: 0.9rem;
                color: green;
                margin-left: 5px;
            }
        </style>
        <script>
            function toggleStatus(id, status, type) {
                fetch(`/toggle-status/${type}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`${type} status updated successfully`);
                        } else {
                            console.error(`Failed to update ${type} status`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            const cardLinks = document.querySelectorAll('.card-link');

            cardLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault();

                    const cardBody = this.querySelector('.card-body');
                    const cardText = cardBody.querySelector('.card-text');
                    const cardLoader = cardBody.querySelector('.card-loader');

                    cardText.classList.add('d-none');
                    cardLoader.classList.remove('d-none');

                    setTimeout(() => {
                        window.location.href = this.href;
                    }, 500);
                });
            });

            window.addEventListener('pageshow', function (event) {
                if (event.persisted) {
                    document.querySelectorAll('.card-loader').forEach(loader => {
                        loader.classList.add('d-none');
                    });
                    document.querySelectorAll('.card-text').forEach(text => {
                        text.classList.remove('d-none');
                    });
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const previousCounts = JSON.parse(localStorage.getItem("dashboardCounts")) || {};

                // @ts-ignore
                const currentCounts = {
                    totalClients: <%= JSON.stringify(totalClients) %>,
                    totalColleges: <%= JSON.stringify(totalColleges) %>,
                    totalGetCommunity: <%= JSON.stringify(totalGetCommunity) %>,
                    totalGiveCommunity: <%= JSON.stringify(totalGiveCommunity) %>,
                    totalPYQs: <%= JSON.stringify(totalPYQs) %>,
                    totalSeniors: <%= JSON.stringify(totalSeniors) %>,
                    totalGroups: <%= JSON.stringify(totalGroups) %>,
                    totalClients: <%= JSON.stringify(totalClients) %>,
                    totalMessages: <%= JSON.stringify(totalMessages) %>,
                    totalPost: <%= JSON.stringify(totalPost) %>,
                    totalRequestedPyqs: <%= JSON.stringify(totalRequestedPyqs) %>
                    // Add other keys as required
                };

                const newCounts = {};
                for (const key in currentCounts) {
                    const previous = previousCounts[key] || 0;
                    const current = currentCounts[key];
                    const diff = current - previous;
                    if (diff > 0) {
                        newCounts[key] = diff;
                    }
                }

                for (const key in newCounts) {
                    const newCountElement = document.querySelector(`.new-count[data-key="${key}"]`);
                    if (newCountElement) {
                        newCountElement.textContent = `+${newCounts[key]}`;
                        newCountElement.classList.remove("d-none");
                    }
                }

                localStorage.setItem("dashboardCounts", JSON.stringify(currentCounts));
            });
        </script>
    </body>